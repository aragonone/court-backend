name: Dashboard CI/CD
on:
  push:
    branches:
    - development
    paths:
    - monitoring/grafana/provisioning/dashboards/court-backend.json

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    # config cluster access (requires KUBE_CA, KUBE_SERVER, KUBE_TOKEN secrets)
    - run: |
        echo ${{ secrets.KUBE_CA }} | base64 -d > ca.crt
        kubectl config set-cluster aragon --server=${{ secrets.KUBE_SERVER }} --certificate-authority=ca.crt
        kubectl config set-credentials aragon --token=$(base64 -d <<< ${{ secrets.KUBE_TOKEN }})
        kubectl config set-context aragon --cluster=aragon --user=aragon
        kubectl config use-context aragon
    # replace Grafana dashboard ConfigMap
    - run: >
        kubectl create configmap court-backend-dashboard --from-file=monitoring/grafana/provisioning/dashboards/court-backend.json --dry-run -o yaml | 
        kubectl label grafana_dashboard=court-backend -f - --local -o yaml | 
        kubectl apply -f -
